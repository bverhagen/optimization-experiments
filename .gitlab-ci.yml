before_script:
    - sed -i 's/git@github.com:/https:\/\/github.com\//' .gitmodules
    - apt-get update -qq && apt-get install --yes -qq cmake scons gcc clang

stages:
    - build
    - test

build-all:
    script: "./exec.py init build --target all --compiler gcc clang"
    stage: build

unittest:
    script: "./exec.py init build run --target all --run unittest --compiler gcc clang"
    stage: test

run-benchmarks-gcc:
    script: "./exec.py init build run --target all --run performance --compiler gcc"
    stage: test

run-benchmarks-clang:
    script: "./exec.py init build run --target all --run performance --compiler clang"
    stage: test

valgrind:
    script: 
        - apt-get install --yes -qq valgrind
        - "./exec.py init build analyze --target all --run unittest --analyze-method valgrind --compiler gcc clang"
    stage: test

cppcheck:
    script: 
        - apt-get install --yes -qq cppcheck unzip
        - "./exec.py analyze -a cppcheck"
    stage: test

clang-static-analyzer:
    script: "./exec.py init analyze -a clang"
    stage: test

pmd-cpd:
    script: 
        - apt-get install --yes -qq default-jre unzip
        - "./exec.py analyze -a cpd"
    stage: test

python2-compatibility:
    script:
        - apt-get install --yes -qq valgrind cppcheck unzip default-jre
        - "python2 exec.py distclean clean init build run rebuild analyze profile -m release -t all -r all -c gcc clang -a clang cppcheck -l perf callgrind"
        - "python2 exec.py build analyze --run unittest --analyze-method valgrind"
    stage: test

python3-compatibility:
    script:
        - apt-get install --yes -qq valgrind cppcheck unzip default-jre python3
        - "python3 exec.py distclean clean init build run rebuild analyze profile -m release -t all -r all -c gcc clang -a clang cppcheck -l perf callgrind"
        - "python3 exec.py build analyze --run unittest --analyze-method valgrind"
    stage: test

perf-profiling:
    script:
        - apt-get install --yes -qq unzip flex bison
        - wget https://github.com/torvalds/linux/archive/master.zip && unzip master.zip && pushd linux-master/tools/perf && make && export PATH=$PATH:$(pwd); popd
        - ./exec.py init build profile --profile-method perf -r performance
    stage: test
